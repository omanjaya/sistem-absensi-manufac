import{a as T,f as U,b as D}from"./index-CpcTDv9q.js";import{e as p,E as w,s as e,r as f,o as N,b as G,c as O,d as W,U as B,f as _,H as A,B as v,v as j,q as K,t as V}from"./vendor-5hdk-FM1.js";import{r as S}from"./ClockIcon-CBPLoeYF.js";import{r as z}from"./CameraIcon-BrnNeVyk.js";function F(c,d){return w(),p("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"}),e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z"})])}function q(){const c=f(null),d=f(null),t=f(null),m=f(!1),o=f(null),g=f(!1),s={width:parseInt(void 0)||640,height:parseInt(void 0)||480,quality:parseFloat(void 0)||.85,facingMode:"user"},h=()=>(g.value=!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),g.value),b=async()=>{if(!h())return o.value="Camera tidak didukung oleh browser ini",!1;m.value=!0,o.value=null;try{const l={video:{width:s.width,height:s.height,facingMode:s.facingMode},audio:!1};return c.value=await navigator.mediaDevices.getUserMedia(l),d.value&&(d.value.srcObject=c.value,await d.value.play()),!0}catch(l){return console.error("Camera access error:",l),l.name==="NotAllowedError"?o.value="Akses kamera ditolak. Silakan izinkan akses kamera.":l.name==="NotFoundError"?o.value="Kamera tidak ditemukan.":l.name==="NotReadableError"?o.value="Kamera sedang digunakan oleh aplikasi lain.":o.value="Gagal mengakses kamera: "+l.message,!1}finally{m.value=!1}},x=()=>{c.value&&(c.value.getTracks().forEach(l=>l.stop()),c.value=null),d.value&&(d.value.srcObject=null)},y=()=>{if(!d.value||!t.value)return o.value="Video atau canvas tidak tersedia",null;const l=t.value.getContext("2d");if(!l)return o.value="Gagal mendapatkan context canvas",null;t.value.width=s.width,t.value.height=s.height,l.drawImage(d.value,0,0,s.width,s.height);try{return t.value.toDataURL("image/jpeg",s.quality).split(",")[1]}catch(k){return o.value="Gagal mengambil foto: "+k.message,null}},C=async()=>{if(!c.value)return o.value="Kamera belum aktif",null;const l=y();if(!l)return null;const k=parseInt(void 0)||2097152,I=l.length*3/4;return I>k?(o.value=`Ukuran foto terlalu besar (${Math.round(I/1024)}KB). Maksimal ${Math.round(k/1024)}KB.`,null):l};return N(()=>{h()}),G(()=>{x()}),{stream:c,video:d,canvas:t,isLoading:m,error:o,isSupported:g,config:s,startCamera:b,stopCamera:x,capturePhoto:y,takePhoto:C,checkSupport:h}}function H(){const c=f(null),d=f(!1),t=f(null),m=f(!1),o={latitude:parseFloat(void 0)||-6.2088,longitude:parseFloat(void 0)||106.8456,radius:parseInt(void 0)||100,name:"Kantor Pusat"},g=()=>(m.value=!!navigator.geolocation,m.value),s=(i,n,a,r)=>{const M=i*Math.PI/180,L=a*Math.PI/180,P=(a-i)*Math.PI/180,E=(r-n)*Math.PI/180,R=Math.sin(P/2)*Math.sin(P/2)+Math.cos(M)*Math.cos(L)*Math.sin(E/2)*Math.sin(E/2);return 6371e3*(2*Math.atan2(Math.sqrt(R),Math.sqrt(1-R)))},h=O(()=>c.value?s(c.value.latitude,c.value.longitude,o.latitude,o.longitude)<=o.radius:!1),b=O(()=>c.value?s(c.value.latitude,c.value.longitude,o.latitude,o.longitude):null),x=()=>new Promise((i,n)=>{if(!g()){n(new Error("Geolocation tidak didukung oleh browser ini"));return}d.value=!0,t.value=null;const a={enableHighAccuracy:!0,timeout:15e3,maximumAge:3e5};navigator.geolocation.getCurrentPosition(r=>{const u={latitude:r.coords.latitude,longitude:r.coords.longitude,accuracy:r.coords.accuracy,timestamp:r.timestamp};c.value=u,d.value=!1,i(u)},r=>{d.value=!1;let u="Gagal mendapatkan lokasi";switch(r.code){case r.PERMISSION_DENIED:u="Akses lokasi ditolak. Silakan izinkan akses lokasi.";break;case r.POSITION_UNAVAILABLE:u="Informasi lokasi tidak tersedia.";break;case r.TIMEOUT:u="Waktu permintaan lokasi habis.";break;default:u=`Error: ${r.message}`;break}t.value=u,n(new Error(u))},a)}),y=i=>{if(!g())return t.value="Geolocation tidak didukung oleh browser ini",null;const n={enableHighAccuracy:!0,timeout:3e4,maximumAge:6e4};return navigator.geolocation.watchPosition(r=>{const u={latitude:r.coords.latitude,longitude:r.coords.longitude,accuracy:r.coords.accuracy,timestamp:r.timestamp};c.value=u,i(u)},r=>{t.value=`Error watching position: ${r.message}`},n)},C=i=>{navigator.geolocation.clearWatch(i)},l=async()=>{try{const i=await x(),n=s(i.latitude,i.longitude,o.latitude,o.longitude);return{valid:n<=o.radius,location:i,distance:n}}catch(i){throw new Error(`Gagal validasi lokasi: ${i.message}`)}},k=i=>i<1e3?`${Math.round(i)}m`:`${(i/1e3).toFixed(1)}km`;return{currentLocation:c,isLoading:d,error:t,isSupported:m,officeLocation:o,isWithinOfficeRadius:h,distanceToOffice:b,checkSupport:g,getCurrentPosition:x,watchPosition:y,clearWatch:C,calculateDistance:s,validateAttendanceLocation:l,formatDistance:k,getLocationStatus:()=>c.value?h.value?`✅ Dalam radius kantor (${k(b.value)})`:`❌ Di luar radius kantor (${k(b.value)})`:"Lokasi belum tersedia"}}const Z={class:"max-w-4xl mx-auto"},J={class:"mb-8"},Q={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},X={class:"card"},Y={class:"flex items-center"},ee={class:"flex-shrink-0"},ae={class:"ml-4"},te={class:"card"},se={class:"flex items-center"},ne={class:"flex-shrink-0"},oe={class:"ml-4"},re={class:"card mb-8"},le={class:"relative bg-gray-900 rounded-lg overflow-hidden mb-4",style:{"aspect-ratio":"4/3"}},ie={key:0,class:"absolute inset-0 flex items-center justify-center"},ce={class:"text-center text-white"},ue={class:"text-lg"},de=["disabled"],me={key:0,class:"flex items-center"},ve={key:1},fe={key:1,class:"absolute inset-4 border-2 border-white border-dashed rounded-lg opacity-50"},he={class:"flex items-center"},ge={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},ke=["disabled"],be={key:0},pe={key:1},we=["disabled"],_e={key:0},xe={key:1},Ie=W({__name:"Attendance",setup(c){const d=T(),t=q(),m=H(),o=f(),g=f(),s=f(null),h=f(!1),b=f(null),x=O(()=>{var n;return t.stream&&m.isWithinOfficeRadius&&!((n=s.value)!=null&&n.clock_in)}),y=O(()=>{var n,a;return t.stream&&m.isWithinOfficeRadius&&((n=s.value)==null?void 0:n.clock_in)&&!((a=s.value)!=null&&a.clock_out)}),C=async()=>{t.video.value=o.value,t.canvas.value=g.value,await t.startCamera()&&d.success("Kamera berhasil diaktifkan")},l=async n=>{h.value=!0,b.value=n;try{const a=await m.validateAttendanceLocation();if(!a.valid)throw new Error(`Anda berada di luar radius kantor (${m.formatDistance(a.distance)})`);const r=await t.takePhoto();if(!r)throw new Error(t.error||"Gagal mengambil foto");const u=await U.recognizeFace(r);if(!u.success)throw new Error(u.message||"Wajah tidak dikenali");const M=await D.createAttendance({photo:r,latitude:a.location.latitude,longitude:a.location.longitude,type:n});s.value=M,d.success(`Absensi ${n==="clock_in"?"masuk":"keluar"} berhasil!`)}catch(a){console.error("Attendance error:",a),d.error(a.message||"Gagal melakukan absensi")}finally{h.value=!1,b.value=null}},k=()=>l("clock_in"),I=()=>l("clock_out"),i=async()=>{try{const n=await D.getTodayAttendance();s.value=n}catch(n){console.error("Failed to fetch today attendance:",n)}};return N(async()=>{t.video.value=o.value,t.canvas.value=g.value,await i();try{await m.getCurrentPosition()}catch(n){console.error("Geolocation error:",n)}}),G(()=>{t.stopCamera()}),(n,a)=>{var r,u,M,L,P,E,R,$;return w(),p("div",Z,[a[5]||(a[5]=e("div",{class:"mb-8"},[e("h1",{class:"text-2xl font-bold text-gray-900"},"Absensi"),e("p",{class:"text-gray-600"},"Lakukan absensi masuk dan keluar dengan pengenalan wajah")],-1)),e("div",J,[e("div",Q,[e("div",X,[e("div",Y,[e("div",ee,[e("div",{class:_(["w-10 h-10 rounded-full flex items-center justify-center",(r=s.value)!=null&&r.clock_in?"bg-green-100":"bg-gray-100"])},[A(v(S),{class:_(["w-6 h-6",(u=s.value)!=null&&u.clock_in?"text-green-600":"text-gray-400"])},null,8,["class"])],2)]),e("div",ae,[a[0]||(a[0]=e("h3",{class:"text-sm font-medium text-gray-900"},"Masuk",-1)),e("p",{class:_(["text-lg font-semibold",(M=s.value)!=null&&M.clock_in?"text-green-600":"text-gray-500"])},j(((L=s.value)==null?void 0:L.clock_in)||"-"),3)])])]),e("div",te,[e("div",se,[e("div",ne,[e("div",{class:_(["w-10 h-10 rounded-full flex items-center justify-center",(P=s.value)!=null&&P.clock_out?"bg-red-100":"bg-gray-100"])},[A(v(S),{class:_(["w-6 h-6",(E=s.value)!=null&&E.clock_out?"text-red-600":"text-gray-400"])},null,8,["class"])],2)]),e("div",oe,[a[1]||(a[1]=e("h3",{class:"text-sm font-medium text-gray-900"},"Keluar",-1)),e("p",{class:_(["text-lg font-semibold",(R=s.value)!=null&&R.clock_out?"text-red-600":"text-gray-500"])},j((($=s.value)==null?void 0:$.clock_out)||"-"),3)])])])])]),e("div",re,[a[4]||(a[4]=e("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Kamera Absensi",-1)),e("div",le,[e("video",{ref_key:"videoRef",ref:o,class:"w-full h-full object-cover",autoplay:"",muted:"",playsinline:""},null,512),e("canvas",{ref_key:"canvasRef",ref:g,class:"hidden"},null,512),v(t).stream?K("",!0):(w(),p("div",ie,[e("div",ce,[A(v(z),{class:"w-16 h-16 mx-auto mb-4 opacity-50"}),e("p",ue,j(v(t).error||"Kamera belum aktif"),1),e("button",{onClick:C,disabled:v(t).isLoading,class:"btn-primary mt-4"},[v(t).isLoading?(w(),p("div",me,a[2]||(a[2]=[e("div",{class:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"},null,-1),V(" Memuat... ")]))):(w(),p("span",ve,"Aktifkan Kamera"))],8,de)])])),v(t).stream?(w(),p("div",fe,a[3]||(a[3]=[e("div",{class:"absolute -top-2 -left-2 w-6 h-6 border-t-2 border-l-2 border-primary-500"},null,-1),e("div",{class:"absolute -top-2 -right-2 w-6 h-6 border-t-2 border-r-2 border-primary-500"},null,-1),e("div",{class:"absolute -bottom-2 -left-2 w-6 h-6 border-b-2 border-l-2 border-primary-500"},null,-1),e("div",{class:"absolute -bottom-2 -right-2 w-6 h-6 border-b-2 border-r-2 border-primary-500"},null,-1)]))):K("",!0)]),e("div",{class:_(["mb-4 p-3 rounded-lg",[v(m).isWithinOfficeRadius?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"]])},[e("div",he,[A(v(F),{class:_(["w-5 h-5 mr-2",v(m).isWithinOfficeRadius?"text-green-600":"text-red-600"])},null,8,["class"]),e("span",{class:_(["text-sm font-medium",v(m).isWithinOfficeRadius?"text-green-800":"text-red-800"])},j(v(m).getLocationStatus()),3)])],2),e("div",ge,[e("button",{onClick:k,disabled:!x.value||h.value,class:"btn-primary flex items-center justify-center"},[A(v(S),{class:"w-5 h-5 mr-2"}),h.value&&b.value==="clock_in"?(w(),p("span",be,"Memproses...")):(w(),p("span",pe,"Absen Masuk"))],8,ke),e("button",{onClick:I,disabled:!y.value||h.value,class:"btn-danger flex items-center justify-center"},[A(v(S),{class:"w-5 h-5 mr-2"}),h.value&&b.value==="clock_out"?(w(),p("span",_e,"Memproses...")):(w(),p("span",xe,"Absen Keluar"))],8,we)])]),a[6]||(a[6]=B('<div class="card bg-blue-50 border border-blue-200"><h3 class="text-lg font-medium text-blue-900 mb-3">Petunjuk Absensi</h3><ul class="space-y-2 text-sm text-blue-800"><li class="flex items-start"><span class="inline-block w-2 h-2 bg-blue-600 rounded-full mt-2 mr-3 flex-shrink-0"></span> Pastikan wajah Anda terlihat jelas di kamera </li><li class="flex items-start"><span class="inline-block w-2 h-2 bg-blue-600 rounded-full mt-2 mr-3 flex-shrink-0"></span> Pastikan Anda berada dalam radius kantor </li><li class="flex items-start"><span class="inline-block w-2 h-2 bg-blue-600 rounded-full mt-2 mr-3 flex-shrink-0"></span> Izinkan akses kamera dan lokasi pada browser </li><li class="flex items-start"><span class="inline-block w-2 h-2 bg-blue-600 rounded-full mt-2 mr-3 flex-shrink-0"></span> Registrasi wajah terlebih dahulu jika belum pernah melakukan absensi </li></ul></div>',1))])}}});export{Ie as default};
